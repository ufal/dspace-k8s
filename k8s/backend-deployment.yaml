apiVersion: apps/v1
kind: Deployment
metadata:
  name: dspace-backend
  labels:
    app: dspace-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dspace-backend
  template:
    metadata:
      labels:
        app: dspace-backend
    spec:
      volumes:
        - name: assetstore
          persistentVolumeClaim:
            claimName: assetstore-pv-claim
        - name: local-config
          configMap:
            name: local-config-map
      containers:
        - name: dspace
          image: dataquest/dspace:customer-palo-docker
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 1000m
              memory: 2Gi
            limits:
              cpu: 4
              memory: 4Gi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            runAsNonRoot: true
            runAsUser: 999
            seccompProfile:
              type: RuntimeDefault
          command: ['/bin/bash', '-c']
          args:
            - |
              # this causes the script to exit immediately if any command exits with a non-zero status
              set -e
              echo "Waiting for Postgres (dspace-postgres-rw:5432) to accept connections...";
              while ! (</dev/tcp/dspace-postgres-rw/5432) >/dev/null 2>&1; do sleep 2; done;
              echo "Waiting for Solr (dspace-solr-service:8983) to accept connections...";
              while ! (</dev/tcp/dspace-solr-service/8983) >/dev/null 2>&1; do sleep 2; done;

              # Setup custom namespace symlink if DSPACE_REST_NAMESPACE is set
              if [ -n "${DSPACE_REST_NAMESPACE}" ]; then
                echo "Setting up custom namespace: ${DSPACE_REST_NAMESPACE}";
                pushd /usr/local/tomcat/webapps && \
                  (unlink server || true) && \
                  (ln -s /dspace/webapps/server/ `echo -n "${DSPACE_REST_NAMESPACE}" | sed -e 's#^/##' -e 'sx/x#x'` || true) && \
                  popd
              fi

              echo "Running database migrations (will retry)...";
              i=0; until /dspace/bin/dspace database migrate force; do i=$((i+1)); echo "Migration failed (attempt $i), retrying in 10s"; sleep 10; done;
              echo "Running index-discovery (best-effort)...";
              /dspace/bin/dspace index-discovery -b || true;

              # Auto-create admin user only if DSPACE_AUTO_CREATE_ADMIN=true (for testing only!)
              if [ "${DSPACE_AUTO_CREATE_ADMIN:-false}" = "true" ]; then
                echo "Creating default admin user...";
                /dspace/bin/dspace create-administrator -e admin@admin.sk -f admin -l admin -p admin -c en || true
              else
                echo "DSPACE_AUTO_CREATE_ADMIN not set: Skipping auto admin creation.";
              fi

              echo "Starting Handle Server...";
              /dspace/bin/start-handle-server || true

              echo "Starting Tomcat";
              ./custom_run.sh
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dspace-postgres-superuser
                  key: password
            # Auto-create admin user with default credentials (ONLY FOR TESTING!)
            - name: DSPACE_AUTO_CREATE_ADMIN
              value: "false"  # Change to "true" if you wish to auto-create admin user

            # S3 Assetstore Configuration
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: AWS_SECRET_ACCESS_KEY
            - name: S3_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: S3_ENDPOINT
            - name: S3_REGION
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: S3_REGION
            - name: S3_BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: S3_BUCKET_NAME
          volumeMounts:
            - name: assetstore
              mountPath: /dspace/assetstore
            - name: local-config
              mountPath: /dspace/config/local.cfg
              subPath: local.cfg
          readinessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 180
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 10
          livenessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 240
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3
          startupProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 180
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 20
