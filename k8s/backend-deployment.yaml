apiVersion: apps/v1
kind: Deployment
metadata:
  name: dspace-backend
  labels:
    app: dspace-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dspace-backend
  template:
    metadata:
      labels:
        app: dspace-backend
    spec:
      securityContext:
        fsGroup: 1100
      volumes:
        - name: assetstore
          persistentVolumeClaim:
            claimName: assetstore-pv-claim
        - name: local-config
          configMap:
            name: local-config-map
      containers:
        - &dspaceContainer
          name: dspace
          image: dataquest/dspace:dspace-7_x
          imagePullPolicy: Always
          resources:
            requests:
              cpu: 1
              memory: 3Gi
            limits:
              cpu: 4
              memory: 6Gi
          securityContext: &dspaceSecurityContext
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            runAsNonRoot: true
            runAsUser: 1100
            seccompProfile:
              type: RuntimeDefault
          command: ['/bin/bash', '-c']
          args:
            - |
              # this causes the script to exit immediately if any command exits with a non-zero status
              set -e

              # TODO see https://github.com/ufal/dspace-k8s/issues/25
              # echo "Starting Handle Server...";
              # /dspace/bin/start-handle-server || true

              echo "Starting Tomcat";
              ./custom_run.sh
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dspace-postgres-superuser
                  key: password

            - name: DSPACE_ADMIN_EMAIL
              valueFrom:
                secretKeyRef:
                  name: dspace-admin-secret
                  key: username

            - name: DSPACE_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: dspace-admin-secret
                  key: password

            # S3 Assetstore Configuration
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: AWS_SECRET_ACCESS_KEY
            - name: S3_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: S3_ENDPOINT
            - name: S3_REGION
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: S3_REGION
            - name: S3_BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: s3-assetstore-secret
                  key: S3_BUCKET_NAME
          volumeMounts:
            - name: assetstore
              mountPath: /dspace/assetstore
            - name: local-config
              mountPath: /dspace/config/local.cfg
              subPath: local.cfg
            - name: local-config
              mountPath: /dspace/bin/user_exists.jsh
              subPath: user_exists.jsh
          readinessProbe:
            httpGet:
              port: 8080
              # This should involve postgres/solr query
              path: /server/api/core/communities
            initialDelaySeconds: 180
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 10
          livenessProbe:
            httpGet:
              port: 8080
              # This IMO shouldn't involve DB/Solr
              path: /server/api
            initialDelaySeconds: 20
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3
          startupProbe:
            httpGet:
              port: 8080
              path: /server/api
            initialDelaySeconds: 35
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 20
      initContainers:
        - name: wait-for-postgres
          image: ghcr.io/cloudnative-pg/postgresql:16.11-system-bullseye
          command: ['/bin/bash', '-c']
          args:
            - |-
              until pg_isready -h dspace-postgres-rw -U dspace; do
                echo "Waiting for Postgres (dspace-postgres-rw:5432)  to be ready...";
                sleep 2;
              done;
              echo "PostgreSQL is ready."
          securityContext: *dspaceSecurityContext
        - name: wait-for-solr
          image: docker.io/curlimages/curl:latest
          command: [ "/bin/sh","-c" ]
          args:
            - |-
              while [ $(curl -sw '%{http_code}' http://dspace-solr-service:8983/solr/admin/info/system -o /dev/null) -ne 200 ]; do
                sleep 2;
                echo "Waiting for Solr (dspace-solr-service:8983) to accept connections...";
              done
          securityContext: *dspaceSecurityContext
        - name: custom-namespace-setup
          image: docker.io/bash:latest
          env:
            - name: DSPACE_REST_NAMESPACE
              value: ""
          command: ['/usr/local/bin/bash', '-c']
          args:
            - |-
              # Setup custom namespace symlink if DSPACE_REST_NAMESPACE is set
              if [ -n "${DSPACE_REST_NAMESPACE}" ]; then
                echo "Setting up custom namespace: ${DSPACE_REST_NAMESPACE}";
                pushd /usr/local/tomcat/webapps && \
                  (unlink server || true) && \
                  (ln -s /dspace/webapps/server/ `echo -n "${DSPACE_REST_NAMESPACE}" | sed -e 's#^/##' -e 'sx/x#x'` || true) && \
                  popd
              else
                echo "DSPACE_REST_NAMESPACE not set: Skipping custom namespace setup.";
              fi
          securityContext: *dspaceSecurityContext
        - <<: *dspaceContainer
          name: dspace-db-migrations
          command: ['/bin/bash', '-c']
          args:
            - |-
              echo "Running database migrations (will retry)...";
              i=0; until /dspace/bin/dspace database migrate force; do
                i=$((i+1));
                echo "Migration failed (attempt $i), retrying in 10s";
                sleep 10;
              done;
              echo "Running index-discovery (best-effort)...";
              /dspace/bin/dspace index-discovery -b || true;
          # No need for probes and ports in init container
          ports: []
          readinessProbe: null
          livenessProbe: null
          startupProbe: null
        - <<: *dspaceContainer
          # TODO: we don't want this in production
          name: dspace-index-discovery
          command: ['/bin/bash', '-c']
          args:
            - |-
              echo "Running index-discovery (best-effort)...";
              /dspace/bin/dspace index-discovery -b || true;
          # No need for probes and ports in init container
          ports: []
          readinessProbe: null
          livenessProbe: null
          startupProbe: null
        - <<: *dspaceContainer
          # TODO secrets and only if not already created
          name: dspace-create-admin
          command: ['/bin/bash', '-c']
          args:
            - |-
              if [ -n "${DSPACE_ADMIN_PASSWORD}" ]; then
              ( jshell -q --class-path /dspace/lib/postgresql-*.jar /dspace/bin/user_exists.jsh | grep "user already exists" ) || (
                echo "Creating admin user...";
                /dspace/bin/dspace create-administrator -e "${DSPACE_ADMIN_EMAIL}" -f admin -l admin -p "${DSPACE_ADMIN_PASSWORD}" -c en
              )
              fi
          # No need for probes and ports in init container
          ports: []
          readinessProbe: null
          livenessProbe: null
          startupProbe: null
